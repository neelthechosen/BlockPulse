<!-- static/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .typeahead-suggestions {
            position: absolute;
            background: white;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-3xl font-bold text-indigo-700 mb-2">Crypto Analysis Dashboard</h1>
            <p class="text-gray-600">Track prices, analyze charts, and explore on-chain data</p>
        </header>

        <!-- Search Section -->
        <div class="max-w-2xl mx-auto mb-12 relative">
            <div class="flex items-center border border-gray-300 rounded-lg bg-white shadow-sm overflow-hidden">
                <i class="fas fa-search text-gray-400 ml-4"></i>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search for any cryptocurrency (e.g. bitcoin, ethereum, solana...)" 
                    class="w-full px-4 py-3 focus:outline-none"
                    autocomplete="off"
                >
                <button id="searchBtn" class="bg-indigo-600 text-white px-6 py-3 font-medium hover:bg-indigo-700 transition">Search</button>
            </div>
            <div id="suggestions" class="typeahead-suggestions hidden"></div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Coin Profile -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex justify-between items-start mb-6">
                    <div class="flex items-center">
                        <img id="coinIcon" src="" alt="" class="w-12 h-12 mr-4 rounded-full">
                        <div>
                            <h2 id="coinName" class="text-2xl font-bold text-gray-800"></h2>
                            <p id="coinSymbol" class="text-gray-500 uppercase"></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-gray-800" id="coinPrice"></p>
                        <p id="priceChange" class="text-lg"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500">Market Cap</p>
                        <p id="marketCap" class="text-xl font-semibold"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500">24h Volume</p>
                        <p id="volume" class="text-xl font-semibold"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500">Rank</p>
                        <p id="coinRank" class="text-xl font-semibold"></p>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Price Chart</h3>
                    <div class="flex space-x-2">
                        <button class="time-btn bg-indigo-100 text-indigo-700 px-3 py-1 rounded-md" data-days="1">24H</button>
                        <button class="time-btn bg-gray-100 text-gray-700 px-3 py-1 rounded-md" data-days="7">7D</button>
                        <button class="time-btn bg-gray-100 text-gray-700 px-3 py-1 rounded-md" data-days="30">30D</button>
                        <button class="time-btn bg-gray-100 text-gray-700 px-3 py-1 rounded-md" data-days="90">90D</button>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Solana Data Section (if available) -->
            <div id="solanaSection" class="hidden bg-white rounded-xl shadow-md p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Solana On-Chain Data</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Token Metadata -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Token Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">Mint Address:</span>
                                <span id="mintAddress" class="font-mono text-sm text-blue-500"></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">Decimals:</span>
                                <span id="tokenDecimals" class="font-semibold"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Supply:</span>
                                <span id="tokenSupply" class="font-semibold"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Transfers -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Recent Transfers</h4>
                        <div id="transfersList" class="space-y-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Top Holders -->
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Top Holders</h4>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div id="holdersList" class="space-y-2">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
                <div class="loader mr-4"></div>
                <p class="text-gray-700">Loading data...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg max-w-md z-50">
            <p id="errorText"></p>
        </div>
    </div>

    <script>
        // Global variables
        let currentCoinId = '';
        let priceChart = null;
        let currentDays = 1;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const suggestionsDiv = document.getElementById('suggestions');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const solanaSection = document.getElementById('solanaSection');

        // Event Listeners
        searchInput.addEventListener('input', debounce(handleSearchInput, 300));
        searchBtn.addEventListener('click', handleSearch);
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-btn').forEach(b => {
                    b.classList.remove('bg-indigo-100', 'text-indigo-700');
                    b.classList.add('bg-gray-100', 'text-gray-700');
                });
                this.classList.remove('bg-gray-100', 'text-gray-700');
                this.classList.add('bg-indigo-100', 'text-indigo-700');
                currentDays = parseInt(this.getAttribute('data-days'));
                if (currentCoinId) {
                    fetchChartData(currentCoinId, currentDays);
                }
            });
        });

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Handle search input for suggestions
        async function handleSearchInput() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                displaySuggestions(data.suggestions);
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }

        // Display search suggestions
        function displaySuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            suggestionsDiv.innerHTML = '';
            suggestions.slice(0, 5).forEach(coin => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <div class="flex items-center">
                        <img src="${coin.thumb}" alt="${coin.name}" class="w-6 h-6 mr-2 rounded-full">
                        <span class="font-medium">${coin.name}</span>
                        <span class="text-gray-500 ml-2 uppercase">${coin.symbol}</span>
                    </div>
                `;
                item.addEventListener('click', () => {
                    searchInput.value = coin.name;
                    suggestionsDiv.classList.add('hidden');
                    currentCoinId = coin.id;
                    handleSearch();
                });
                suggestionsDiv.appendChild(item);
            });
            suggestionsDiv.classList.remove('hidden');
        }

        // Handle search button click
        function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            // Try to find the coin ID from suggestions if not already set
            if (!currentCoinId) {
                // This is a simplified approach - in a real app you might want to do another search
                showError('Please select a coin from the suggestions');
                return;
            }

            fetchCoinData(currentCoinId);
        }

        // Fetch coin data from backend
        async function fetchCoinData(coinId) {
            showLoading();
            try {
                // Fetch price data
                const priceResponse = await fetch(`/api/price/${coinId}`);
                if (!priceResponse.ok) throw new Error('Failed to fetch price data');
                const priceData = await priceResponse.json();

                // For demonstration, we'll use mock data for the coin details
                // In a real application, you would fetch this from the CoinGecko API
                const coinDetails = {
                    name: coinId.charAt(0).toUpperCase() + coinId.slice(1),
                    symbol: coinId.slice(0, 3).toUpperCase(),
                    image: {
                        large: `https://coin-images.coingecko.com/coins/images/1/large/bitcoin.png?1547033579`
                    },
                    market_data: {
                        market_cap: { usd: priceData.market_cap },
                        total_volume: { usd: priceData.volume },
                    },
                    market_cap_rank: 1
                };

                displayCoinData(coinDetails, priceData);
                fetchChartData(coinId, currentDays);

                // Check if this is a Solana token and fetch on-chain data
                if (coinId.includes('solana') || coinId === 'solana') {
                    // For demonstration, using a known Solana token mint address
                    const mintAddress = 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'; // USDC mint
                    fetchSolanaData(mintAddress);
                } else {
                    solanaSection.classList.add('hidden');
                }

            } catch (error) {
                console.error('Error fetching coin data:', error);
                showError('Failed to fetch data. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Display coin data in the UI
        function displayCoinData(coinDetails, priceData) {
            document.getElementById('coinName').textContent = coinDetails.name;
            document.getElementById('coinSymbol').textContent = coinDetails.symbol;
            document.getElementById('coinIcon').src = coinDetails.image.large;
            document.getElementById('coinPrice').textContent = formatCurrency(priceData.price);
            
            const changeElement = document.getElementById('priceChange');
            changeElement.textContent = `${priceData.change_24h >= 0 ? '+' : ''}${priceData.change_24h.toFixed(2)}%`;
            changeElement.className = `text-lg ${priceData.change_24h >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('marketCap').textContent = formatCurrency(priceData.market_cap);
            document.getElementById('volume').textContent = formatCurrency(priceData.volume);
            document.getElementById('coinRank').textContent = `#${coinDetails.market_cap_rank}`;
            
            resultsDiv.classList.remove('hidden');
        }

        // Fetch chart data
        async function fetchChartData(coinId, days) {
            try {
                const response = await fetch(`/api/chart/${coinId}?days=${days}`);
                if (!response.ok) throw new Error('Failed to fetch chart data');
                
                const data = await response.json();
                renderPriceChart(data.prices, days);
            } catch (error) {
                console.error('Error fetching chart data:', error);
                showError('Failed to load chart data.');
            }
        }

        // Render price chart
        function renderPriceChart(prices, days) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (priceChart) {
                priceChart.destroy();
            }
            
            const labels = prices.map(point => {
                const date = new Date(point.time);
                return days <= 1 
                    ? date.toLocaleTimeString() 
                    : date.toLocaleDateString();
            });
            
            const data = prices.map(point => point.price);
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price (USD)',
                        data: data,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Price: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fetch Solana token data
        async function fetchSolanaData(mintAddress) {
            try {
                const response = await fetch(`/api/solana/${mintAddress}`);
                if (!response.ok) throw new Error('Failed to fetch Solana data');
                
                const data = await response.json();
                displaySolanaData(data, mintAddress);
            } catch (error) {
                console.error('Error fetching Solana data:', error);
                solanaSection.classList.add('hidden');
            }
        }

        // Display Solana token data
        function displaySolanaData(data, mintAddress) {
            // Display token metadata
            document.getElementById('mintAddress').textContent = mintAddress;
            document.getElementById('tokenDecimals').textContent = data.metadata.decimals || 'N/A';
            document.getElementById('tokenSupply').textContent = formatNumber(data.metadata.supply || 0);
            
            // Display recent transfers
            const transfersList = document.getElementById('transfersList');
            transfersList.innerHTML = '';
            
            if (data.recent_transfers && data.recent_transfers.length > 0) {
                data.recent_transfers.slice(0, 3).forEach(transfer => {
                    const transferElement = document.createElement('div');
                    transferElement.className = 'bg-gray-50 p-3 rounded-lg';
                    transferElement.innerHTML = `
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">From: ${transfer.source.substring(0, 8)}...</span>
                            <span class="font-medium">${transfer.amount} tokens</span>
                        </div>
                    `;
                    transfersList.appendChild(transferElement);
                });
            } else {
                transfersList.innerHTML = '<p class="text-gray-500">No recent transfers</p>';
            }
            
            // Display top holders
            const holdersList = document.getElementById('holdersList');
            holdersList.innerHTML = '';
            
            if (data.top_holders && data.top_holders.length > 0) {
                data.top_holders.slice(0, 5).forEach(holder => {
                    const holderElement = document.createElement('div');
                    holderElement.className = 'flex justify-between py-1';
                    holderElement.innerHTML = `
                        <span class="text-gray-600 truncate max-w-xs">${holder.address.substring(0, 12)}...</span>
                        <span class="font-medium">${formatNumber(holder.amount)} (${holder.percentage.toFixed(2)}%)</span>
                    `;
                    holdersList.appendChild(holderElement);
                });
            } else {
                holdersList.innerHTML = '<p class="text-gray-500">No holder data available</p>';
            }
            
            solanaSection.classList.remove('hidden');
        }

        // Utility function to format currency
        function formatCurrency(value) {
            if (!value) return '$0.00';
            if (value >= 1e9) {
                return '$' + (value / 1e9).toFixed(2) + 'B';
            } else if (value >= 1e6) {
                return '$' + (value / 1e6).toFixed(2) + 'M';
            } else if (value >= 1e3) {
                return '$' + (value / 1e3).toFixed(2) + 'K';
            } else {
                return '$' + value.toFixed(2);
            }
        }

        // Utility function to format numbers
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1e9) {
                return (num / 1e9).toFixed(2) + 'B';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(2) + 'M';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(2) + 'K';
            } else {
                return num.toString();
            }
        }

        // Show loading indicator
        function showLoading() {
            loadingDiv.classList.remove('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            loadingDiv.classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!suggestionsDiv.contains(e.target) && e.target !== searchInput) {
                suggestionsDiv.classList.add('hidden');
            }
        });

        // Initialize with a popular coin
        window.addEventListener('load', function() {
            searchInput.value = 'bitcoin';
            currentCoinId = 'bitcoin';
            handleSearch();
        });
    </script>
</body>
</html>
